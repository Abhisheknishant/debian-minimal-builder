sudo: enabled
dist: bionic

language: minimal

branches:
    only:
    - master
    - /^v.*/

install:
    - sudo apt-get update
    - make build-depends
    - sudo update-binfmts --disable
    - sudo rm /var/lib/binfmts/qemu-*
    - sudo sed -i 's/bionic/cosmic/g' /etc/apt/sources.list
    - sudo apt-get update
    - sudo apt-get install qemu-user-static
    - cat /proc/sys/fs/binfmt_misc/qemu-arm
    - cat /proc/sys/fs/binfmt_misc/qemu-riscv64

script:
    - make build/debian.buster.armhf.cpio CONFIG_DEBIAN_ARCH=armhf
    - make build/debian.buster.arm64.cpio CONFIG_DEBIAN_ARCH=arm64
    - make build/debian.buster.i386.cpio CONFIG_DEBIAN_ARCH=i386
    - make build/debian.buster.amd64.cpio CONFIG_DEBIAN_ARCH=amd64
    - make build/debian.buster.mipsel.cpio CONFIG_DEBIAN_ARCH=mipsel
    - make build/debian.unstableports.riscv64.cpio CONFIG_DEBIAN_ARCH=riscv64 CONFIG_DEBIAN=unstableports
    - make test CONFIG_DISABLE_KVM=yes

before_deploy:
    - git config --local user.name "Automated Dummy User"
    - git config --local user.email "noreply@example.com"
    - git remote set-url origin https://${TRAVIS_REPO_SLUG%%/*}:$GITHUB_TOKEN@github.com/$TRAVIS_REPO_SLUG
    - test -z "$TRAVIS_TAG" && git tag --force prerelease
    - test -z "$TRAVIS_TAG" && git push --force --tags
    - test -z "$TRAVIS_TAG" && export TRAVIS_TAG=prerelease

deploy:
    provider: releases
    api_key: "$GITHUB_TOKEN"
    skip_cleanup: true
    body: "Automatic release created by travis-ci integration"
    prerelease: true
    overwrite: true
    file:
        - "build/debian.buster.armhf.cpio"
        - "build/debian.buster.arm64.cpio"
        - "build/debian.buster.i386.cpio"
        - "build/debian.buster.amd64.cpio"
        - "build/debian.buster.mipsel.cpio"
        - "build/debian.unstableports.riscv64.cpio"
